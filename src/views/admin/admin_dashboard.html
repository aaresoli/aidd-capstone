{% extends "layout.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<div class="container py-4 admin-shell" data-admin-dashboard>
    <div class="dashboard-hero mb-4">
        <div>
            <p class="eyebrow text-uppercase mb-1">System overview</p>
            <h1 class="h2 mb-2">Admin control center</h1>
            <p class="text-muted mb-0">Keep resources tidy, approvals moving, and feedback constructive.</p>
        </div>
        <div class="hero-buttons">
            <a href="{{ url_for('admin.manage_users') }}" class="btn btn-primary"><i class="bi bi-people"></i> Users</a>
            <a href="{{ url_for('admin.manage_resources') }}" class="btn btn-outline-secondary"><i class="bi bi-box"></i> Resources</a>
            <a href="{{ url_for('admin.manage_bookings') }}" class="btn btn-outline-secondary"><i class="bi bi-calendar-event"></i> Bookings</a>
            <a href="{{ url_for('admin.manage_reviews') }}" class="btn btn-outline-secondary"><i class="bi bi-star"></i> Reviews</a>
            <a href="{{ url_for('admin.moderation_reports') }}" class="btn btn-outline-secondary"><i class="bi bi-flag"></i> Reports</a>
        </div>
    </div>

    <div class="stat-grid mb-4">
        <div class="stat-card">
            <p class="stat-label">Total users</p>
            <p class="stat-value">{{ stats.total_users }}</p>
            <span class="stat-hint text-muted">{{ stats.students }} students Â· {{ stats.staff + stats.admins }} staff/admin</span>
        </div>
        <div class="stat-card">
            <p class="stat-label">Published resources</p>
            <p class="stat-value">{{ stats.total_resources }}</p>
            <span class="stat-hint text-muted">{{ resource_status.draft }} drafts waiting</span>
        </div>
        <div class="stat-card">
            <p class="stat-label">Pending bookings</p>
            <p class="stat-value">{{ stats.pending_bookings }}</p>
            <span class="stat-hint text-muted">Queued for review</span>
        </div>
        <div class="stat-card">
            <p class="stat-label">Admin team</p>
            <p class="stat-value">{{ stats.admins }}</p>
            <span class="stat-hint text-muted">{{ stats.staff }} staff moderators</span>
        </div>
    </div>

    <div class="status-grid mb-4">
        <div class="status-card">
            <div class="status-label">Drafts</div>
            <div class="status-value">{{ resource_status.draft }}</div>
        </div>
        <div class="status-card">
            <div class="status-label">Published</div>
            <div class="status-value">{{ resource_status.published }}</div>
        </div>
        <div class="status-card">
            <div class="status-label">Archived</div>
            <div class="status-value">{{ resource_status.archived }}</div>
        </div>
    </div>

    <div class="row g-4 mb-4 analytics-grid">
        <div class="col-xl-8">
            <div class="dashboard-card chart-card h-100">
                <div class="card-head">
                    <h3 class="h5 mb-0">Booking velocity</h3>
                    <span class="text-muted small">Requests submitted (6 months)</span>
                </div>
                <canvas id="bookingTrendChart" height="280" role="img" aria-label="Line chart showing monthly booking submissions"></canvas>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="dashboard-card chart-card mb-4">
                <div class="card-head">
                    <h3 class="h5 mb-0">Role mix</h3>
                    <span class="text-muted small">Active accounts</span>
                </div>
                <canvas id="roleMixChart" height="220" role="img" aria-label="Doughnut chart showing user roles"></canvas>
            </div>
            <div class="dashboard-card chart-card">
                <div class="card-head">
                    <h3 class="h5 mb-0">Booking decisions</h3>
                    <span class="text-muted small">Status breakdown</span>
                </div>
                <canvas id="bookingStatusChart" height="220" role="img" aria-label="Doughnut chart showing booking status distribution"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4 analytics-grid">
        <div class="col-xl-8">
            <div class="dashboard-card chart-card h-100">
                <div class="card-head">
                    <h3 class="h5 mb-0">New registrations</h3>
                    <span class="text-muted small">Rolling 6 months</span>
                </div>
                <canvas id="userGrowthChart" height="280" role="img" aria-label="Bar chart showing recent user registrations"></canvas>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="dashboard-card chart-card h-100">
                <div class="card-head">
                    <h3 class="h5 mb-0">Top resource categories</h3>
                    <span class="text-muted small">Most listed</span>
                </div>
                <canvas id="categoryChart" height="280" role="img" aria-label="Horizontal bar chart showing resource categories"></canvas>
            </div>
        </div>
    </div>
    {% if department_usage %}
    <div class="dashboard-card mb-4">
        <div class="card-head">
            <h3 class="h5 mb-0">Bookings by department</h3>
            <span class="text-muted small">Top requesters</span>
        </div>
        <div class="chart-wrapper mb-3">
            <canvas id="departmentUsageChart" height="260" role="img" aria-label="Bar chart showing departmental booking counts"></canvas>
        </div>
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead>
                    <tr>
                        <th>Department</th>
                        <th class="text-end">Bookings</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in department_usage %}
                    <tr>
                        <td>{{ row.department }}</td>
                        <td class="text-end">
                            <span class="badge bg-light text-dark">{{ row.total }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="dashboard-card h-100">
                <div class="card-head">
                    <h3 class="h5 mb-0">Recent users</h3>
                    <a href="{{ url_for('admin.manage_users') }}" class="text-muted small">See all</a>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.name }}</td>
                                <td class="text-muted small">{{ user.email }}</td>
                                <td><span class="badge bg-light text-dark text-uppercase">{{ user.role }}</span></td>
                                <td class="text-end">
                                    <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.user_id) }}" onsubmit="return confirm('Delete this user?');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="dashboard-card h-100">
                <div class="card-head">
                    <h3 class="h5 mb-0">Bookings waiting on action</h3>
                    <a href="{{ url_for('admin.manage_bookings') }}" class="text-muted small">Jump to queue</a>
                </div>
                {% if pending_bookings %}
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Resource</th>
                                <th>Date</th>
                                <th class="text-end">Open</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in pending_bookings %}
                            <tr>
                                <td>#{{ booking.booking_id }}</td>
                                <td>Resource #{{ booking.resource_id }}</td>
                                <td>{{ booking.start_datetime|datetime_format('%b %d, %H:%M') }}</td>
                                <td class="text-end">
                                    <a href="{{ url_for('booking.detail', booking_id=booking.booking_id) }}" class="btn btn-sm btn-outline-secondary">View</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="empty-state text-muted mb-0">No pending bookings right now.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script id="admin-chart-data" type="application/json">
        {{ chart_data|default({})|tojson }}
    </script>
    <script src="{{ url_for('static', filename='js/vendor/chart.umd.min.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/admin_dashboard.js') }}" defer></script>
{% endblock %}
